# HÆ°á»›ng dáº«n Deploy vá»›i PostgreSQL Database trÃªn Render

## ğŸ¯ Tá»•ng quan

á»¨ng dá»¥ng Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ tá»± Ä‘á»™ng:
- âœ… Táº¡o PostgreSQL database (free tier)
- âœ… Káº¿t ná»‘i database tá»± Ä‘á»™ng
- âœ… Cháº¡y migrations khi deploy
- âœ… Sá»­ dá»¥ng database cho session, cache, queue

## ğŸ“ CÃ¡c bÆ°á»›c Deploy

### BÆ°á»›c 1: Commit & Push Code

```bash
git add .
git commit -m "Configure PostgreSQL database for Render deployment"
git push origin main
```

### BÆ°á»›c 2: Deploy trÃªn Render

1. **VÃ o Render Dashboard**: https://dashboard.render.com
2. **Táº¡o má»›i hoáº·c update service**:
   - Náº¿u chÆ°a cÃ³: New + â†’ Web Service â†’ Connect GitHub repo
   - Náº¿u Ä‘Ã£ cÃ³: Trigger Manual Deploy

3. **Render sáº½ tá»± Ä‘á»™ng**:
   - Táº¡o PostgreSQL database `modernshop-db`
   - Link database vá»›i web service
   - Set cÃ¡c environment variables tá»« database
   - Build Docker image
   - Deploy application

### BÆ°á»›c 3: Set APP_KEY

**QUAN TRá»ŒNG**: Pháº£i set APP_KEY manually!

```bash
# Generate APP_KEY
bash generate-app-key.sh

# Hoáº·c
php -r "echo 'base64:'.base64_encode(random_bytes(32)).PHP_EOL;"
```

ThÃªm vÃ o Render Environment Variables:
```
Key: APP_KEY
Value: base64:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
```

### BÆ°á»›c 4: Xem Logs & Verify

Sau khi deploy, check logs:

âœ… **Logs mong Ä‘á»£i:**
```
ğŸš€ Starting Laravel application on PORT=10000...
âœ… APP_KEY is set (length: 51)
ğŸ”’ Setting permissions...
ğŸ”§ Optimizing Laravel...
â³ Database configured (dpg-xxxxx.oregon-postgres.render.com), waiting for connection...
âœ… Database connected! Running migrations...
ğŸ“¦ Running database migrations...
   INFO  Running migrations.
   âœ“ 0001_01_01_000000_create_users_table ............. DONE
   âœ“ 0001_01_01_000001_create_categories_table ....... DONE
   ...
âœ… Laravel is responding!
Ready to accept connections!
```

## ğŸ—„ï¸ Database Schema

Migrations sáº½ tá»± Ä‘á»™ng táº¡o cÃ¡c báº£ng:
- users
- categories
- products
- carts
- orders
- order_details
- sessions
- cache
- jobs
- failed_jobs
- ... vÃ  nhiá»u báº£ng khÃ¡c

## ğŸ” Kiá»ƒm tra Database

### Option 1: Qua Render Dashboard

1. VÃ o Database service: `modernshop-db`
2. Click "Connect" â†’ Copy connection string
3. Sá»­ dá»¥ng psql hoáº·c DB client Ä‘á»ƒ connect

### Option 2: Qua Web Service Shell

```bash
# Trong Render Shell
php artisan db:show

# Xem cÃ¡c báº£ng
php artisan db:table --all

# Cháº¡y seeder (náº¿u cáº§n)
php artisan db:seed --force
```

## ğŸ¨ Cáº¥u hÃ¬nh Database

### PostgreSQL Connection Info (tá»± Ä‘á»™ng tá»« Render):

```
DB_CONNECTION=pgsql
DB_HOST=dpg-xxxxx.oregon-postgres.render.com
DB_PORT=5432
DB_DATABASE=modernshop
DB_USERNAME=modernshop
DB_PASSWORD=<auto-generated>
```

### Session & Cache (sá»­ dá»¥ng database):

```
SESSION_DRIVER=database
CACHE_DRIVER=database
QUEUE_CONNECTION=database
```

## ğŸš¨ Troubleshooting

### Lá»—i: Database connection timeout

**NguyÃªn nhÃ¢n**: Database chÆ°a ready hoáº·c network issue

**Fix**: Entrypoint script cÃ³ retry 30 láº§n (60 seconds), thÆ°á»ng sáº½ tá»± fix

### Lá»—i: Migration failed

**NguyÃªn nhÃ¢n**: Database Ä‘Ã£ cÃ³ báº£ng hoáº·c schema conflict

**Fix**:
```bash
# Trong Render Shell
php artisan migrate:fresh --force
```

### Lá»—i: Could not find driver

**NguyÃªn nhÃ¢n**: PostgreSQL driver chÆ°a cÃ i

**Fix**: ÄÃ£ Ä‘Æ°á»£c thÃªm vÃ o Dockerfile (pdo_pgsql, pgsql)

## ğŸ“Š Database Limits (Free Tier)

- Storage: 1 GB
- RAM: 256 MB
- Connection limit: 97
- Expires after 90 days of inactivity
- Automatic backups: No (upgrade for backups)

## ğŸ”„ Migrations & Seeding

### Tá»± Ä‘á»™ng khi deploy:
```bash
php artisan migrate --force
```

### Manual (qua Shell):
```bash
# Fresh migration (xÃ³a táº¥t cáº£ vÃ  táº¡o láº¡i)
php artisan migrate:fresh --force

# Cháº¡y seeder
php artisan db:seed --force

# Hoáº·c migration + seed
php artisan migrate:fresh --seed --force
```

## ğŸ¯ Next Steps

Sau khi database hoáº¡t Ä‘á»™ng:

1. **Test á»©ng dá»¥ng**: Truy cáº­p https://your-app.onrender.com
2. **Táº¡o admin user**: Cháº¡y seeder hoáº·c táº¡o manual
3. **Import data**: Náº¿u cÃ³ data tá»« local
4. **Monitor logs**: Äáº£m báº£o khÃ´ng cÃ³ database errors
5. **Set APP_DEBUG=false**: Khi production-ready

## ğŸ’¡ Tips

- Free tier database sleep sau 15 phÃºt khÃ´ng dÃ¹ng â†’ cold start ~5-10 giÃ¢y
- Backup data Ä‘á»‹nh ká»³ (export/import manual)
- Monitor database size (limit 1GB)
- Optimize queries Ä‘á»ƒ giáº£m connection time
- Sá»­ dá»¥ng database indexes cho performance

## ğŸ”— Resources

- Render PostgreSQL Docs: https://render.com/docs/databases
- Laravel PostgreSQL: https://laravel.com/docs/database#postgresql
- Connection troubleshooting: Check Render logs
